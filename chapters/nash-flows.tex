\section{Charakterisierung dynamischer Nash-Flüsse}

\begin{definition}\label{def-flow-along-active-edges}
	Man sage, der Fluss $f$ \emph{fließe nur entlang aktiver Kanten}, falls $f_{vw}^+$ fast überall auf $l_v(\Theta_{vw}^c)$ verschwindet für alle Kanten $vw\in E$.
\end{definition}

\todo{$l_v, T_e$ ist absolut stetig und surjektiv}

\todo{PROBLEM: Queues waren irgendwann leer}

\begin{remark}
	Diese Definition weicht von der Defintion von Koch und Skutella ab und entspricht derjenigen aus~\cite[Definition 1]{Cominetti2015}:
	Nach \cite[Definition 2]{Koch2011} sagt man, $f$ \emph{sende Fluss nur entlang aktuell kürzester Pfade}, falls $f_{vw}^+\circ l_v$ fast überall auf $\Theta_{vw}^c$ verschwindet für alle Kanten $vw$.
	
	Entspricht $f$ dieser Definition, so auch Definition~\ref{def-flow-along-active-edges}: 
	Da $l_v$ absolut stetig ist, bildet es nach~\cite[Aufgabe 4.9]{Elstrodt2011} Nullmengen wieder auf Nullmengen ab, weshalb folgende Menge Nullmenge ist: $$l_v(\{ \theta \in \Theta_{vw}^c \mid f_{vw}^+ (l_v(\theta)) > 0 \}) = \{ \xi \in l_v(\Theta_{vw}^c) \mid f_{vw}^+ (\xi) > 0 \}.$$
	 
	Koch und Skutella zeigen im Beweis von~\cite[Lemma 1]{Koch2011} die entsprechende Äquivalenz von \ref{lemma-only-active-edges} (i) und \ref{lemma-only-active-edges} (iii) und
	verwenden im Teil (iii)$\Rightarrow$(i) das Argument, dass für jede Kante $vw\in E$ und alle $\theta\in \Theta_{vw}^c$ eine Umgebung $U$ von $\theta$ existiert, sodass $f_{vw}^+$ fast überall in $l_v(U)$ verschwindet.
	Dies reicht aber nicht aus, um zu zeigen, dass $f_{vw}^+(l_v(\theta))=0$ für fast alle $\theta\in\Theta_{vw}^c$ gilt:
	So kann $f_{vw}^+(l_v(\theta))$ für ein $\theta\in\Theta_{vw}^c$ positiv sein und $l_v$ konstant in einer Umgebung um $\theta$.
	Dann ist $f_{vw}^+ \circ l_v$ in einer Umgebung um $\theta$ positiv, was im Widerspruch zur Forderung ist.
	
	Dies wurde in~\cite[Example 2]{Cominetti2015} ausgenutzt, um ein Beispielfluss anzugeben, der zeigt, dass die Forderung sogar echt stärker ist.
\end{remark}

\begin{lemma}\label{lemma-vanishes-intervals}
	Seien $g: \R \to \R_{\geq 0}$ eine lokal Lebesgue-integrierbare Funktion und $((a_i, b_i))_{i\in I}$ eine Familie offener Intervalle.
	Dann verschwindet $g$ fast überall auf $\Theta:=\bigcup_{i\in I} (a_i, b_i)$ genau dann, wenn es für alle $i\in I$ fast überall auf $(a_i, b_i)$ verschwindet.
\end{lemma}
\begin{proof}
	Verschwindet $g$ fast überall auf $\Theta$, so erst recht auf jedem Intervall $(a_i, b_i)$.
	Für die andere Richtung definiert die Funktion $\mu(A):= \int_A g \diff \lambda$ ein Maß auf den Borelmengen~$\mathfrak{B}$.
	Da jede offene Menge $O\subseteq\R$ $\sigma$-kompakt ist, also eine Darstellung als abzählbare Vereinigung kompakter Mengen -- hier $O=\bigcup_{n\in\N}(\{ x \in\R \mid d(x, O^c) \geq 1/n \} \cap [-n, n] )$ -- besitzt, ist jede offene Menge nach~\cite[1.2 Folgerungen (e)]{Elstrodt2011} innen regulär.
	Dies heißt, dass für offene Mengen $O\subseteq\R$ $$\mu(O)=\sup\{ \mu(K) \mid K\subseteq O \text{ kompakt} \}$$ gilt.
	Für ein kompaktes $K\subseteq \Theta$ existiert eine endliche Teilüberdeckung $\bigcup_{i=1}^n (a_k, b_i) \supseteq K$, für die $\mu(K) \leq \sum_{i=1}^{n} \mu((a_i, b_i)) = \sum_{k=1}^{n} \int_{a_i}^{b_i} g(t) \diff t = 0$ gilt.
	Also ist auch $\mu(\Theta)=0$.
\end{proof}

\begin{lemma}\label{lemma-only-active-edges}
	Für einen zulässigen Fluss $f$ sind folgende Aussagen äquivalent:
	\begin{enumerate}[label=(\roman*)]
		\item Der Fluss $f$ fließt nur entlang aktiver Kanten.
		\item Für jede Kante $vw\in E$ und für fast alle $\xi\in\R$ mit	$f_{vw}^+(\xi)>0$ gilt $\xi \in l_v(\Theta_{vw})$.
		\item Für jede Kante $vw\in E$ und für alle $\theta\in\R$ gilt $F_{vw}^+(l_v(\theta)) = F_{vw}^-(l_w(\theta))$.
	\end{enumerate}
\end{lemma}
\begin{proof}
	$(i) \Leftrightarrow (ii)$: Bedingung~(ii) gilt genau dann, wenn $f_{vw}^+$ fast überall auf $l_v(\Theta_{vw})^c$ verschwindet.
	Um die Äquivalenz zu beweisen, reicht es also zu zeigen, dass sich $l_v(\Theta_{vw})^c$ und $l_v(\Theta_{vw}^c)$ nur um eine Nullmenge voneinander unterscheiden.
	Für ein $\xi\in l_v(\Theta_{vw})^c$ existiert wegen der Surjektivität von $l_v$ nach Proposition~\ref{prop-abs-cont-sur} ein $\theta\in\R$ mit $l_v(\theta)=\xi$ und $\theta\notin\Theta_{vw}$, da $\xi\notin l_v(\Theta_{vw})$. 
	Also ist $\xi\in l_v(\Theta_{vw}^c)$ und es gilt $l_v(\Theta_{vw})^c\subseteq l_v(\Theta_{vw}^c)$.
	
	Des Weiteren ist $l_v(\Theta_{vw}^c)\setminus l_v(\Theta_{vw})^c = l_v(\Theta_{vw}^c)\cap l_v(\Theta_{vw})\subseteq l_v(\Q)$:
	Für ein $\xi$ aus der linken Menge existieren $\theta\in\Theta_{vw}^c$ und $\theta'\in\Theta_{vw}$ mit $l_v(\theta)=\xi=l_v(\theta')$.
	Da $\theta\neq\theta'$ ist, existiert ein $\theta_q\in\Q$ zwischen $\theta$ und $\theta'$.
	Wegen der Monotonie von $l_v$ gilt $l_v(\theta_q)=\xi$ und $\xi\in l_v(\Q)$.
	Also unterscheiden sich die beiden Mengen nur um eine abzählbare Menge.
	
	$(i)\Leftrightarrow (iii)$: Sei eine Kante $vw\in E$ gegeben.
	Die Beziehung $F_{vw}^-(T_{vw}(l_v(\theta))) \geq F_{vw}^-(l_w(\theta))$ gilt bereits wegen der Monotonie von $F_{vw}^-$ und Lemma~\ref{lemma-dreicksungl} für alle $\theta\in\R$.

	Für ein $\theta\in\R$ bezeichne man den spätesten Startzeitpunkt kleiner oder gleich $\theta$, sodass man unter Benutzung von $vw$ gerade zum Zeitpunkt $l_w(\theta)$ zu $w$ gelangt, als
	$$\omega_\theta:=\max\{ \omega\leq\theta \mid l_w(\theta) = T_{vw}(l_v(\omega)) \}.$$
	Dieses Maximum existiert, da die Menge nach oben beschränkt, abgeschlossen und wegen des Zwischenwertsatzes mit $T_{vw}(l_v(\theta))\geq l_w(\theta)$ und $\lim_{t\to -\infty}T_{vw}(l_v(t))=-\infty$ (\todo{ref}) nicht-leer ist.
	
	Es ist $\Theta_{vw}^c = \bigcup_{\theta\in\R} (\omega_\theta, \theta)$:
	Für $\theta\in\Theta_{vw}^c$ gilt $T_{vw}(l_v(\theta)) > l_w(\theta)$.
	Aufgrund der Stetigkeit von $T_{vw}\circ l_v$ und von $l_w$ existiert ein $\varepsilon>0$, sodass $T_{vw}(l_v(\theta')) > l_w(\theta+\varepsilon)$ für $\theta'\in[\theta,\theta+\varepsilon]$ gilt.
	Also ist $\theta\in(\omega_{\theta+\varepsilon}, \theta+\varepsilon)$.
	Ist umgekehrt $\theta'\in (\omega_\theta,\theta)$, so ist aufgrund der Monotonie $T_{vw}(l_v(\theta'))\geq T_{vw}(l_v(\omega_\theta)) = l_w(\theta)\geq l_w(\theta')$.
	Dies kann nicht mit Gleichheit erfüllt sein, da $w_\theta$ maximal mit der Eigenschaft $T_{vw}(l_v(\omega)) = l_w(\theta)$ ist.
	Also ist $vw$ zum Zeitpunkt $\theta'$ inaktiv.
	
	Insbesondere gilt $l_v(\Theta_{vw}^c) = \bigcup_{\theta\in\R}(l_v(\omega_\theta),l_v(\theta))$ wegen der Monotonie von $l_v$.
	Nach Lemma~\ref{lemma-vanishes-intervals} verschwindet $f_{vw}^+$ genau dann fast überall auf $l_v(\Theta_{vw})^c$, wenn es für alle $\theta\in\R$ fast überall auf $(l_v(\omega_\theta),l_v(\theta))$ verschwindet.
	Dies ist nach Proposition~\ref{prop-feasible-flow}~\ref{prop-feasible-flow-det-outflow} wiederum äquivalent zu
	$$F_{vw}^+(l_v(\theta))-F_{vw}^+(l_v(\omega_\theta)) = F_{vw}^+(l_v(\theta))-F_{vw}^-(l_w(\theta))=0~~\text{für alle $\theta\in\R$}.$$
\end{proof}


\todo{blablabla Definition FIFO bla}

\begin{definition}
	Für eine Kante $vw\in E$ bezeichne $x_{vw}^+(\theta):= F_{vw}^+(l_v(\theta))$ die Flussmenge, die die Kante $vw$ betreten hat, bevor Partikel, die zur Zeit $\theta$ in $s$ starten, $v$ erreichen können.
	
	Mit $x_{vw}^-(\theta):= F^-_{vw}(l_w(\theta))$ bezeichne man die Flussmenge, die die Kante $vw$ verlassen hat, bevor Partikel, die zur Zeit $\theta$ in $s$ starten, $w$ erreichen können.
	
	Für einen Knoten $v\in V$ sei $b_v(\theta):=\sum_{e\in\delta^+(v)} x_e^+(\theta) - \sum_{e\in\delta^-(v)} x_e^-(\theta)$ die Balance des Knoten $v$ zum Zeitpunkt $\theta$.
\end{definition}


\begin{remark}\label{remark-x^-leqx^+}
	In einem zulässigen Fluss ist $x_{vw}^-(\theta) = F_{vw}^-(l_w(\theta)) \leq F_{vw}^-(T_{vw}(l_v(\theta)))=F_{vw}^+(l_v(\theta)) = x_{vw}^+(\theta)$
	 nach Proposition~\ref{prop-feasible-flow}~\ref{prop-feasible-flow-det-outflow} und mit der Monotonie von $F_{vw}^+$.
\end{remark}

\begin{lemma}\label{lemma-balance-0}
	Für einen zulässigen dynamischen Fluss $f$ gilt $b_v(\theta)=0$ für alle Knoten $v\in V\setminus\{ s,t \}$ und alle $\theta\in\R$.
\end{lemma}
\begin{proof}
	Unter Benutzung der Voraussetzung~\ref{def-feasible-flow-no-flow-at-node} folgere man für $v\in V\setminus \{ s, t\}, \theta\in\R$:
	$$\sum_{e\in\delta^-(v)} x_e^-(\theta) = \int_{0}^{l_v(\theta)} \sum_{e\in\delta^-(v)} f_e^-(t) \diff t = \int_{0}^{l_v(\theta)} \sum_{e\in\delta^+(v)} f_e^+(t) \diff t = \sum_{e\in\delta^+(v)}x_e^+(\theta)$$
\end{proof}

\begin{definition}
	Man sage, ein zulässiger dynamischer Fluss $f$ \emph{fließe ohne Überholungen}, falls $b_s(\theta) = -b_t(\theta)$ für alle $\theta\in\R$.
\end{definition}

\todo{blabla definition blabla}

\begin{definition}
	Seien ein statischer Fluss $f \in \R^E$ in einem Graphen $G=(V,E)$ mit Kapazitäten $u\in \R_+^E$ und ein Balancevektor $b\in\R^V$ mit $\sum_{v\in V} b_v = 0$ gegeben.
	Der Fluss $f$ heißt \emph{$b$-Fluss}, falls er Flusserhaltung bzgl. $b$ gewährt, d.h. falls er für alle $v\in V$ die Bedingung $\sum_{e\in\delta^+(v)}f_e - \sum_{e\in\delta^-(v)}f_e = b_v$ erfüllt.
\end{definition}

\todo{blabla}

\newcommand{\newv}{\mathbf{v}}
\begin{lemma}\label{lemma-b-graph}
	Seien ein dynamischer Fluss $f$ in einem Graphen $G=(V,E)$ und ein Zeitpunkt $\theta\in\R$ gegeben.
	Der Graph $H$ entstehe aus $G$, indem man jede Kante $vw\in E$ aus $G$ durch einen neuen Knoten $\newv_{vw}$ und zwei Kanten $v\newv_{vw}$ und $\newv_{vw}w$ ersetze.
	Der statische Fluss $g$ auf $H$ sei definiert durch
	$$g_{v\newv_{vw}} := x_{vw}^+(\theta) \text{ und } g_{\newv_{vw}w} := x_{vw}^-(\theta) \text{ für alle $vw\in E$}$$
	und die Balance $b$ auf $H$ sei gegeben durch $b_v:= b_v(\theta)$ für $v\in V$ und $b_{\newv_e}:= x_e^-(\theta) - x_e^+(\theta)$ für $e\in E$.
	Dann gelten die folgenden Aussagen:
	
	\begin{enumerate}[label=(\roman*)]
		\item Der Fluss $g$ ist ein statischer $b$-Fluss.
		\item\label{lemma-b-graph-imp} Ist $f$ zulässig, so gilt $\forall e\in E : x_e^+(\theta) = x_e^-(\theta)\iff b_s(\theta) + b_t(\theta) = 0$.
	\end{enumerate}
\end{lemma} 
\begin{proof}
	$(i)$: Um zu zeigen, dass die Summe über die Balanceeinträge verschwindet, erkenne man, dass der Anteil einer Kante $e\in E$ in $\sum_{v_\in V} b_v$ gerade $x_e^+(\theta) - x_e^-(\theta)$ ist.
	Damit gilt:
		$$\sum_{v\in V}b_v + \sum_{e\in E} b_{\newv_e} = \sum_{e\in E}  (x_e^+(\theta) - x_e^-(\theta) + x_e^-(\theta) - x_e^+(\theta)) = 0.$$
		Es bleibt zu zeigen, dass $g$ bezüglich $b$ Flusserhaltung gewährt.
		Für die Knoten der Form $\newv_{vw}$ gilt dies, da $g_{\newv_{vw}w} - g_{v\newv_{vw}} = x_{vw}^-(\theta) - x_{vw}^+(\theta) = b_{\newv_{vw}}$.
		Für $v\in V$ gilt nach Konstruktion $$b_v =
		\sum_{e\in\delta^+_G(v)} x_{e}^+(\theta) - \sum_{e\in\delta^-_G(v)} x_{e}^-(\theta) =
	\sum_{e\in\delta_H^+(v)} g_e - \sum_{e\in\delta^-_H(v)}g_e
		.$$
	
	$(ii)$: Tatsächlich benötigt man aus $(i)$ nur die Eigenschaft, dass die Summe über die Einträge des Balancevektors verschwindet.
	Mit Lemma~\ref{lemma-balance-0} gilt wegen der Zulässigkeit von $f$ sogar $b_s(\theta)+b_t(\theta) + \sum_{e\in E} b_{\newv_e} = 0$.
	
	Angenommen, es gelte $x_e^+(\theta) = x_e^-(\theta)$ für alle $e\in E$.
	Dann sind auch alle $b_{\newv_e} = 0$ und es gilt $b_s(\theta) + b_t(\theta) = 0$.
	Setzt man $b_s(\theta) + b_t(\theta) = 0$ voraus, so ist $\sum_{e\in E} b_{\newv_e} = 0$ und, da $f$ zulässig ist, gilt $x_e^-(\theta)\leq x_e^+(\theta)$ nach Bemerkung~\ref{remark-x^-leqx^+}.
	Daher gilt $b_{\newv_e}\leq 0$ für alle $e\in E$, weshalb bereits alle $b_{\newv_e} = 0$ sein müssen.
\end{proof}


\begin{theorem}\label{thm-equivalencies-nash-flow}
	Für einen zulässigen dynamischen Fluss $f$ sind die folgenden Aussagen äquivalent:
	\begin{enumerate}[label=(\roman*)]
		\item Der Fluss $f$ fließt nur entlang aktiver Kanten
		\item Für alle Kanten $e\in E$ und zu allen Zeitpunkten $\theta\in\R$ ist $x_e^+(\theta) = x_e^-(\theta)$.
		\item Der Fluss $f$ fließt ohne Überholungen.
	\end{enumerate}
	Gilt eine dieser Aussagen, so nennt man $f$ einen \emph{dynamischen Nash-Fluss}.
\end{theorem}
\begin{proof}
	$(i) \Leftrightarrow (ii):$ Für eine Kante $vw\in E$ und einen Zeitpunkt $\theta\in\R$ gilt nach Proposition~\ref{prop-feasible-flow}~\ref{prop-feasible-flow-det-outflow}:
	$$x_{vw}^+(\theta) - x_{vw}^-(\theta) = F_{vw}^+(l_v(\theta)) - F_{vw}^-(l_w(\theta)) = F_{vw}^-(T_{vw}(l_v(\theta))) - F_{vw}^-(l_w(\theta)).$$
	Lemma~\ref{lemma-only-active-edges} schafft also die gewünschte Äquivalenz.
	
	$(ii) \Leftrightarrow (iii)$ ist eine direkte Folgerung von Lemma~\ref{lemma-b-graph}~\ref{lemma-b-graph-imp}.
\end{proof}

\begin{remark}\label{remark-s-t-flow}
	In einem Nash-Fluss ist der statische Fluss $x(\theta)$ mit $x_e(\theta):=x_e^+(\theta)=x_e^-(\theta)$ nach Lemma~\ref{lemma-balance-0} ein statischer $s$-$t$-Fluss für jedes $\theta\in\R$.
	Ist $x_e$ für alle $e\in E$ differenzierbar in $\theta$, so ist auch $x'(\theta)$ ein statischer $s$-$t$-Fluss, da Differenzieren die Flusserhaltung beibehält.
\end{remark}